<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Resi Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Load QR Code Generator Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Load Firebase/Firestore for environment compatibility -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Global variables provided by the environment
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : null;
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      let db, auth;

      // Function to initialize Firebase and authenticate
      async function initializeFirebase() {
        if (!firebaseConfig) {
          console.error("Firebase configuration is missing.");
          return;
        }

        try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // Set logging level for debugging
          setLogLevel("Debug");

          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
          console.log("Firebase Authentication successful.");
        } catch (error) {
          console.error(
            "Error during Firebase initialization or authentication:",
            error
          );
        }
      }

      // Initialize when the script loads
      initializeFirebase();
    </script>
    <style>
      /* Menghapus semua custom CSS untuk slider, scroll-snap, dan overflow */
      /* Kontainer sekarang hanya berisi satu kartu terpusat */
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen font-sans">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
      <header class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-indigo-700">
          QR Code Resi Generator
        </h1>
        <p class="text-lg text-gray-500 mt-2">
          Masukkan beberapa nomor resi untuk membuat Kode QR secara instan.
        </p>
      </header>

      <!-- Input Section -->
      <div
        class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-10 max-w-2xl mx-auto"
      >
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Input Resi</h2>
        <textarea
          id="resi-input"
          rows="6"
          class="w-full p-4 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
          placeholder="Masukkan nomor resi, pisahkan dengan baris baru (Enter) atau koma.&#10;Contoh:&#10;JKT123456789&#10;SBY987654321&#10;BDG112233445"
        ></textarea>

        <button
          id="generate-btn"
          class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50"
        >
          Generate QR Code
        </button>

        <div
          id="error-message"
          class="mt-4 text-red-500 font-medium hidden"
        ></div>
      </div>

      <!-- Output Section (QR Code Container) -->
      <!-- Bagian ini disembunyikan secara default menggunakan class 'hidden' -->
      <div id="output-section" class="mt-10 hidden max-w-2xl mx-auto">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Hasil QR Code</h2>

        <!-- Information message for slider (Akan disembunyikan jika hanya 1 resi) -->
        <div
          id="info-slider"
          class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-lg mb-6 hidden"
          role="alert"
        >
          <p class="font-bold">Mode Navigasi Aktif</p>
          <p>Gunakan tombol panah untuk melihat kode QR berikutnya.</p>
        </div>

        <!-- Wrapper for the single card and navigation buttons -->
        <div
          id="navigation-wrapper"
          class="relative py-4 flex items-center justify-center"
        >
          <!-- Navigation Buttons (Kiri/Previous) - Default hidden -->
          <button
            id="prev-btn"
            disabled
            class="absolute left-4 z-10 p-3 bg-white rounded-full shadow-xl hover:bg-gray-100 transition duration-150 top-1/2 -translate-y-1/2 disabled:opacity-30 disabled:cursor-not-allowed hidden /* Mengganti -translate-x-1/2 dengan left-4 dan mengatur posisi desktop */ md:left-1/4 xl:left-1/4"
          >
            <!-- Icon Previous -->
            <svg
              class="w-6 h-6 text-indigo-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="3"
                d="M15 19l-7-7 7-7"
              ></path>
            </svg>
          </button>

          <!-- The single card container. Hanya akan menampung satu kartu. -->
          <div id="single-card-wrapper" class="w-full mx-auto">
            <!-- Card content will be dynamically injected here -->
          </div>

          <!-- Navigation Buttons (Kanan/Next) - Default hidden -->
          <button
            id="next-btn"
            disabled
            class="absolute right-4 z-10 p-3 bg-white rounded-full shadow-xl hover:bg-gray-100 transition duration-150 top-1/2 -translate-y-1/2 disabled:opacity-30 disabled:cursor-not-allowed hidden /* Mengganti translate-x-1/2 dengan right-4 dan mengatur posisi desktop */ md:right-1/4 xl:right-1/4"
          >
            <!-- Icon Next -->
            <svg
              class="w-6 h-6 text-indigo-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="3"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        const $input = $("#resi-input");
        const $generateBtn = $("#generate-btn");
        const $wrapper = $("#single-card-wrapper"); // Kontainer tunggal untuk kartu
        const $errorMsg = $("#error-message");
        const $outputSection = $("#output-section");
        const $prevBtn = $("#prev-btn");
        const $nextBtn = $("#next-btn");
        const $infoSlider = $("#info-slider");

        let resiNumbers = [];
        let currentIndex = 0;
        const qrcodeId = "qrcode-canvas"; // ID tetap untuk canvas QR code

        // --- START: Implementasi Fitur Keamanan ---
        /**
         * Memeriksa apakah aplikasi dijalankan di lingkungan GitHub Pages.
         * @returns {boolean} True jika domain mengandung 'github.io'.
         */
        function isRunningOnGitHubPages() {
          const hostname = window.location.hostname;
          // Memeriksa domain umum GitHub Pages
          return hostname.includes("github.io");
        }

        /**
         * Menerapkan tindakan keamanan (nonaktifkan klik kanan, Inspect Element, View Source).
         */
        function applySecurityMeasures() {
          console.log("Fitur keamanan diaktifkan.");

          // 1. Nonaktifkan Klik Kanan (Menu Konteks)
          document.addEventListener("contextmenu", function (e) {
            e.preventDefault();
            // console.log("Klik kanan dinonaktifkan.");
          });

          // 2. Nonaktifkan Pintasan Keyboard (F12, Ctrl+Shift+I, Ctrl+U, dll.)
          document.addEventListener("keydown", function (e) {
            // F12 key
            if (e.keyCode === 123 || e.which === 123) {
              e.preventDefault();
              // console.log("F12 (Inspect Element) dinonaktifkan.");
              return;
            }

            // Pintasan Ctrl/Cmd (View Source, Inspect Element, Console)
            if (e.ctrlKey || e.metaKey) {
              // Ctrl for Windows/Linux, Cmd for macOS
              const key = String.fromCharCode(e.which).toLowerCase();

              // Ctrl+Shift+I atau Ctrl+I (Inspect Element)
              if ((e.shiftKey && key === "i") || key === "i") {
                e.preventDefault();
                // console.log("Ctrl+Shift+I (Inspect Element) dinonaktifkan.");
                return;
              }

              // Ctrl+U (View Source)
              if (key === "u") {
                e.preventDefault();
                // console.log("Ctrl+U (View Source) dinonaktifkan.");
                return;
              }
            }
          });
        }

        if (isRunningOnGitHubPages()) {
          applySecurityMeasures();
        }
        // --- END: Implementasi Fitur Keamanan ---

        /**
         * Function to display a non-alert message.
         * @param {string} message The message to display.
         * @param {boolean} isError If true, displays as an error. Otherwise, hides the error box.
         */
        function showMessage(message, isError) {
          if (isError) {
            $errorMsg.text(message).removeClass("hidden");
          } else {
            $errorMsg.addClass("hidden").text("");
          }
        }

        /**
         * Updates the state (disabled/enabled) and visibility of the Prev/Next buttons.
         */
        function updateNavButtons() {
          const totalCards = resiNumbers.length;

          if (totalCards <= 1) {
            // Sembunyikan tombol dan pesan info jika 0 atau 1 resi
            $prevBtn.addClass("hidden");
            $nextBtn.addClass("hidden");
            $infoSlider.addClass("hidden");
            return;
          }

          // Tampilkan tombol dan pesan info
          $prevBtn.removeClass("hidden");
          $nextBtn.removeClass("hidden");
          $infoSlider.removeClass("hidden");

          // Update disabled state berdasarkan currentIndex
          $prevBtn.prop("disabled", currentIndex === 0);
          $nextBtn.prop("disabled", currentIndex === totalCards - 1);
        }

        /**
         * Function to render the QR code for the current index into the single card structure.
         * @param {number} index The index of the resi number to display.
         */
        function renderCard(index) {
          const resi = resiNumbers[index];
          if (!resi) return;

          // 1. Injeksi struktur kartu jika belum ada
          if (
            $wrapper.children().length === 0 ||
            $wrapper.find("#dynamic-card").length === 0
          ) {
            $wrapper.html(`
                        <div id="dynamic-card" class="bg-white p-6 rounded-xl shadow-xl transition duration-300">
                            <h3 id="card-title" class="text-lg font-bold text-indigo-600 mb-4 truncate"></h3>
                            <div id="${qrcodeId}-container" class="flex justify-center p-3 bg-gray-50 rounded-lg">
                                <div id="${qrcodeId}"></div>
                            </div>
                            <p id="card-index" class="text-sm text-gray-500 mt-4 text-center"></p>
                            <p class="text-xs text-gray-400 mt-2 text-center">Data: <span id="card-data"></span></p>
                        </div>
                    `);
          }

          // 2. Update konten dengan data resi baru
          $("#card-title").text(`Resi: ${resi}`).attr("title", resi);
          $("#card-data").text(resi);
          $("#card-index").text(`Kode ${index + 1} dari ${resiNumbers.length}`);

          // 3. Hapus QR code sebelumnya dan buat ulang
          $(`#${qrcodeId}`).empty();
          try {
            new QRCode(document.getElementById(qrcodeId), {
              text: resi,
              width: 180,
              height: 180,
              colorDark: "#1f2937",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.H,
            });
          } catch (e) {
            console.error("Error generating QR code:", resi, e);
            $(`#${qrcodeId}`).html(
              '<p class="text-red-500">Gagal membuat QR Code.</p>'
            );
          }

          // 4. Perbarui status tombol
          updateNavButtons();
        }

        /**
         * Mengubah currentIndex dan memanggil renderCard.
         * @param {'prev' | 'next'} direction
         */
        function navigateSlider(direction) {
          const totalCards = resiNumbers.length;
          if (totalCards <= 1) return;

          let newIndex = currentIndex;
          if (direction === "next") {
            newIndex = Math.min(currentIndex + 1, totalCards - 1);
          } else {
            // 'prev'
            newIndex = Math.max(currentIndex - 1, 0);
          }

          // Hanya render ulang jika index berubah
          if (newIndex !== currentIndex) {
            currentIndex = newIndex;
            renderCard(currentIndex);
          }
        }

        /**
         * Function utama untuk memproses input dan memulai rendering.
         */
        function generateQRCodes() {
          // 1. Get and clean the input
          const rawInput = $input.val().trim();

          // 2. Proses resi numbers
          resiNumbers = rawInput
            .split(/[\n,]+/)
            .map((resi) => resi.trim())
            .filter((resi) => resi.length > 0)
            .slice(0, 1000); // Limit to 1000 for performance

          $wrapper.empty(); // Hapus konten sebelumnya

          if (resiNumbers.length === 0) {
            showMessage(
              "Mohon masukkan setidaknya satu nomor resi yang valid.",
              true
            );
            // Sembunyikan seluruh bagian hasil QR Code jika terjadi error
            $outputSection.addClass("hidden");
            updateNavButtons(); // Pastikan tombol navigasi juga disembunyikan
            return;
          }

          // 3. Hanya tampilkan bagian output jika input valid
          $outputSection.removeClass("hidden");
          showMessage("", false); // Hapus pesan error sebelumnya

          // 4. Inisialisasi dan render kartu pertama
          currentIndex = 0;
          renderCard(currentIndex);
        }

        // Event listener for the button click
        $generateBtn.on("click", generateQRCodes);

        // Event listeners for navigation
        $prevBtn.on("click", () => navigateSlider("prev"));
        $nextBtn.on("click", () => navigateSlider("next"));

        // Optional: Allow pressing Enter in the textarea to trigger generation
        $input.on("keypress", function (e) {
          if (e.which === 13 && !e.shiftKey) {
            // 13 is Enter, check shiftKey to allow newlines
            e.preventDefault();
            generateQRCodes();
          }
        });

        // Initial setup on load to hide buttons
        updateNavButtons();
      });
    </script>
  </body>
</html>
